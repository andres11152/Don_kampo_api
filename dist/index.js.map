{"version":3,"file":"index.js","names":["express","morgan","authRoutes","usersRoutes","productsRoutes","shippingRoutes","orderRoutes","customerTypesRoutes","multer","optimizeImage","cors","dotenv","helmet","path","fs","config","app","use","process","env","NODE_ENV","__dirname","dirname","URL","import","meta","url","pathname","logStream","createWriteStream","join","flags","stream","json","urlencoded","extended","storage","memoryStorage","upload","single","allowedOrigins","ALLOWED_ORIGINS","split","corsOptions","origin","callback","includes","console","error","Error","methods","allowedHeaders","credentials","post","req","res","log","file","status","message","options","static","get","indexPath","resolve","sendFile","err","send","port","PORT","listen","on","server","close","exit"],"sources":["../src/index.js"],"sourcesContent":["import express from 'express';\r\nimport morgan from 'morgan';\r\nimport authRoutes from './routes/auth.routes.js';\r\nimport usersRoutes from './routes/user.routes.js';\r\nimport productsRoutes from './routes/products.routes.js';\r\nimport shippingRoutes from './routes/shipping.routes.js';\r\nimport orderRoutes from './routes/order.routes.js';\r\nimport customerTypesRoutes from './routes/customerTypes.routes.js';\r\nimport multer from 'multer';\r\nimport { optimizeImage } from './middlewares/imageMiddleware.js';\r\nimport cors from 'cors';\r\nimport dotenv from 'dotenv';\r\nimport helmet from 'helmet';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\n\r\ndotenv.config();\r\n\r\nconst app = express();\r\n\r\n// Seguridad con Helmet\r\napp.use(helmet());\r\n\r\n// Configuración de logging\r\nif (process.env.NODE_ENV === 'production') {\r\n  const __dirname = path.dirname(new URL(import.meta.url).pathname);\r\n  const logStream = fs.createWriteStream(path.join(__dirname, 'access.log'), { flags: 'a' });\r\n  app.use(morgan('combined', { stream: logStream }));\r\n} else {\r\n  app.use(morgan('dev'));\r\n}\r\n\r\n// Middleware para analizar JSON y formularios\r\napp.use(express.json());\r\napp.use(express.urlencoded({ extended: false }));\r\n\r\n// Configuración de Multer para subir archivos (imagen)\r\nconst storage = multer.memoryStorage();\r\nconst upload = multer({ storage: storage }).single('photo');\r\n\r\n// Configuración de CORS\r\nconst allowedOrigins = process.env.ALLOWED_ORIGINS ? process.env.ALLOWED_ORIGINS.split(',') : [\r\n  'https://donkampo.com', // Origen permitido\r\n  'http://localhost:3000', // Origen local\r\n  'http://localhost:3001', // Origen local\r\n];\r\n\r\nconst corsOptions = {\r\n  origin: (origin, callback) => {\r\n    if (!origin || allowedOrigins.includes(origin)) {\r\n      callback(null, true);\r\n    } else {\r\n      console.error(`Origen bloqueado por CORS: ${origin}`);\r\n      callback(new Error('No permitido por CORS'));\r\n    }\r\n  },\r\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\r\n  allowedHeaders: ['Content-Type', 'Authorization'],\r\n  credentials: true,\r\n};\r\n\r\n// Aplicar CORS\r\napp.use(cors(corsOptions));\r\n\r\n// Rutas de la aplicación\r\napp.use(authRoutes);\r\napp.use(usersRoutes);\r\napp.use(productsRoutes);\r\napp.use(shippingRoutes);\r\napp.use(orderRoutes);\r\napp.use(customerTypesRoutes);\r\n\r\n// Ruta para crear un producto y optimizar la imagen\r\napp.post('/api/createproduct', upload, optimizeImage, (req, res) => {\r\n  console.log('Imagen subida:', req.file);\r\n  res.status(201).json({ message: 'Producto creado exitosamente' });\r\n});\r\n\r\n// Middleware para manejar solicitudes OPTIONS (Preflight)\r\napp.options('*', cors(corsOptions)); // Asegura que los preflight requests sean manejados correctamente\r\n\r\n// Configuración de vistas\r\nconst __dirname = path.dirname(new URL(import.meta.url).pathname);\r\napp.use(express.static(path.join(__dirname, 'public')));\r\n\r\n// Redirigir todas las solicitudes al archivo HTML en producción\r\napp.get('*', (req, res) => {\r\n  // Asegurarse de que la ruta a index.html es absoluta\r\n  const indexPath = path.resolve(__dirname, 'public', 'index.html');\r\n  res.sendFile(indexPath, (err) => {\r\n    if (err) {\r\n      res.status(500).send('Error al cargar la página');\r\n    }\r\n  });\r\n});\r\n\r\n// Configuración del servidor\r\nconst port = process.env.PORT || 8080;\r\n\r\napp.listen(port, '0.0.0.0', () => {\r\n  console.log(`Servidor corriendo en http://localhost:${port}`);\r\n});\r\n\r\n// Manejo de la señal SIGINT para cerrar el servidor de manera adecuada\r\nprocess.on(\"SIGINT\", () => {\r\n  server.close(() => {\r\n    console.log(\"Servidor cerrado correctamente\");\r\n    process.exit(0);\r\n  });\r\n});\r\n"],"mappings":"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","ignoreList":[]}