{"version":3,"file":"index.js","names":["_express","_interopRequireDefault","require","_morgan","_authRoutes","_userRoutes","_productsRoutes","_shippingRoutes","_orderRoutes","_customerTypesRoutes","_multer","_imageMiddleware","_cors","_dotenv","_helmet","_path","_fs","dotenv","config","app","express","use","helmet","process","env","NODE_ENV","__dirname","path","dirname","URL","import","meta","url","pathname","logStream","fs","createWriteStream","join","flags","morgan","stream","json","urlencoded","extended","storage","multer","memoryStorage","upload","single","allowedOrigins","ALLOWED_ORIGINS","split","corsOptions","origin","callback","includes","console","error","Error","methods","allowedHeaders","credentials","cors","authRoutes","usersRoutes","productsRoutes","shippingRoutes","orderRoutes","customerTypesRoutes","post","optimizeImage","req","res","log","file","status","message","options","static","get","indexPath","resolve","sendFile","err","send","port","PORT","listen","on","server","close","exit"],"sources":["../src/index.js"],"sourcesContent":["import express from 'express';\r\nimport morgan from 'morgan';\r\nimport authRoutes from './routes/auth.routes.js';\r\nimport usersRoutes from './routes/user.routes.js';\r\nimport productsRoutes from './routes/products.routes.js';\r\nimport shippingRoutes from './routes/shipping.routes.js';\r\nimport orderRoutes from './routes/order.routes.js';\r\nimport customerTypesRoutes from './routes/customerTypes.routes.js';\r\nimport multer from 'multer';\r\nimport { optimizeImage } from './middlewares/imageMiddleware.js';\r\nimport cors from 'cors';\r\nimport dotenv from 'dotenv';\r\nimport helmet from 'helmet';\r\nimport path from 'path';\r\nimport fs from 'fs';\r\n\r\ndotenv.config();\r\n\r\nconst app = express();\r\n\r\n// Seguridad con Helmet\r\napp.use(helmet());\r\n\r\n// Configuración de logging\r\nif (process.env.NODE_ENV === 'production') {\r\n  const __dirname = path.dirname(new URL(import.meta.url).pathname);\r\n  const logStream = fs.createWriteStream(path.join(__dirname, 'access.log'), { flags: 'a' });\r\n  app.use(morgan('combined', { stream: logStream }));\r\n} else {\r\n  app.use(morgan('dev'));\r\n}\r\n\r\n// Middleware para analizar JSON y formularios\r\napp.use(express.json());\r\napp.use(express.urlencoded({ extended: false }));\r\n\r\n// Configuración de Multer para subir archivos (imagen)\r\nconst storage = multer.memoryStorage();\r\nconst upload = multer({ storage: storage }).single('photo');\r\n\r\n// Configuración de CORS\r\nconst allowedOrigins = process.env.ALLOWED_ORIGINS ? process.env.ALLOWED_ORIGINS.split(',') : [\r\n  'https://donkampo.com', // Origen permitido\r\n  'http://localhost:3000', // Origen local\r\n  'http://localhost:3001', // Origen local\r\n];\r\n\r\nconst corsOptions = {\r\n  origin: (origin, callback) => {\r\n    if (!origin || allowedOrigins.includes(origin)) {\r\n      callback(null, true);\r\n    } else {\r\n      console.error(`Origen bloqueado por CORS: ${origin}`);\r\n      callback(new Error('No permitido por CORS'));\r\n    }\r\n  },\r\n  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],\r\n  allowedHeaders: ['Content-Type', 'Authorization'],\r\n  credentials: true,\r\n};\r\n\r\n// Aplicar CORS\r\napp.use(cors(corsOptions));\r\n\r\n// Rutas de la aplicación\r\napp.use(authRoutes);\r\napp.use(usersRoutes);\r\napp.use(productsRoutes);\r\napp.use(shippingRoutes);\r\napp.use(orderRoutes);\r\napp.use(customerTypesRoutes);\r\n\r\n// Ruta para crear un producto y optimizar la imagen\r\napp.post('/api/createproduct', upload, optimizeImage, (req, res) => {\r\n  console.log('Imagen subida:', req.file);\r\n  res.status(201).json({ message: 'Producto creado exitosamente' });\r\n});\r\n\r\n// Middleware para manejar solicitudes OPTIONS (Preflight)\r\napp.options('*', cors(corsOptions)); // Asegura que los preflight requests sean manejados correctamente\r\n\r\n// Configuración de vistas\r\nconst __dirname = path.dirname(new URL(import.meta.url).pathname);\r\napp.use(express.static(path.join(__dirname, 'public')));\r\n\r\n// Redirigir todas las solicitudes al archivo HTML en producción\r\napp.get('*', (req, res) => {\r\n  // Asegurarse de que la ruta a index.html es absoluta\r\n  const indexPath = path.resolve(__dirname, 'public', 'index.html');\r\n  res.sendFile(indexPath, (err) => {\r\n    if (err) {\r\n      res.status(500).send('Error al cargar la página');\r\n    }\r\n  });\r\n});\r\n\r\n// Configuración del servidor\r\nconst port = process.env.PORT || 8080;\r\n\r\napp.listen(port, '0.0.0.0', () => {\r\n  console.log(`Servidor corriendo en http://localhost:${port}`);\r\n});\r\n\r\n// Manejo de la señal SIGINT para cerrar el servidor de manera adecuada\r\nprocess.on(\"SIGINT\", () => {\r\n  server.close(() => {\r\n    console.log(\"Servidor cerrado correctamente\");\r\n    process.exit(0);\r\n  });\r\n});\r\n"],"mappings":";;;AAAA,IAAAA,QAAA,GAAAC,sBAAA,CAAAC,OAAA;AACA,IAAAC,OAAA,GAAAF,sBAAA,CAAAC,OAAA;AACA,IAAAE,WAAA,GAAAH,sBAAA,CAAAC,OAAA;AACA,IAAAG,WAAA,GAAAJ,sBAAA,CAAAC,OAAA;AACA,IAAAI,eAAA,GAAAL,sBAAA,CAAAC,OAAA;AACA,IAAAK,eAAA,GAAAN,sBAAA,CAAAC,OAAA;AACA,IAAAM,YAAA,GAAAP,sBAAA,CAAAC,OAAA;AACA,IAAAO,oBAAA,GAAAR,sBAAA,CAAAC,OAAA;AACA,IAAAQ,OAAA,GAAAT,sBAAA,CAAAC,OAAA;AACA,IAAAS,gBAAA,GAAAT,OAAA;AACA,IAAAU,KAAA,GAAAX,sBAAA,CAAAC,OAAA;AACA,IAAAW,OAAA,GAAAZ,sBAAA,CAAAC,OAAA;AACA,IAAAY,OAAA,GAAAb,sBAAA,CAAAC,OAAA;AACA,IAAAa,KAAA,GAAAd,sBAAA,CAAAC,OAAA;AACA,IAAAc,GAAA,GAAAf,sBAAA,CAAAC,OAAA;AAEAe,eAAM,CAACC,MAAM,CAAC,CAAC;AAEf,MAAMC,GAAG,GAAG,IAAAC,gBAAO,EAAC,CAAC;;AAErB;AACAD,GAAG,CAACE,GAAG,CAAC,IAAAC,eAAM,EAAC,CAAC,CAAC;;AAEjB;AACA,IAAIC,OAAO,CAACC,GAAG,CAACC,QAAQ,KAAK,YAAY,EAAE;EACzC,MAAMC,SAAS,GAAGC,aAAI,CAACC,OAAO,CAAC,IAAIC,GAAG,CAACC,MAAM,CAACC,IAAI,CAACC,GAAG,CAAC,CAACC,QAAQ,CAAC;EACjE,MAAMC,SAAS,GAAGC,WAAE,CAACC,iBAAiB,CAACT,aAAI,CAACU,IAAI,CAACX,SAAS,EAAE,YAAY,CAAC,EAAE;IAAEY,KAAK,EAAE;EAAI,CAAC,CAAC;EAC1FnB,GAAG,CAACE,GAAG,CAAC,IAAAkB,eAAM,EAAC,UAAU,EAAE;IAAEC,MAAM,EAAEN;EAAU,CAAC,CAAC,CAAC;AACpD,CAAC,MAAM;EACLf,GAAG,CAACE,GAAG,CAAC,IAAAkB,eAAM,EAAC,KAAK,CAAC,CAAC;AACxB;;AAEA;AACApB,GAAG,CAACE,GAAG,CAACD,gBAAO,CAACqB,IAAI,CAAC,CAAC,CAAC;AACvBtB,GAAG,CAACE,GAAG,CAACD,gBAAO,CAACsB,UAAU,CAAC;EAAEC,QAAQ,EAAE;AAAM,CAAC,CAAC,CAAC;;AAEhD;AACA,MAAMC,OAAO,GAAGC,eAAM,CAACC,aAAa,CAAC,CAAC;AACtC,MAAMC,MAAM,GAAG,IAAAF,eAAM,EAAC;EAAED,OAAO,EAAEA;AAAQ,CAAC,CAAC,CAACI,MAAM,CAAC,OAAO,CAAC;;AAE3D;AACA,MAAMC,cAAc,GAAG1B,OAAO,CAACC,GAAG,CAAC0B,eAAe,GAAG3B,OAAO,CAACC,GAAG,CAAC0B,eAAe,CAACC,KAAK,CAAC,GAAG,CAAC,GAAG,CAC5F,sBAAsB;AAAE;AACxB,uBAAuB;AAAE;AACzB,uBAAuB,CAAE;AAAA,CAC1B;AAED,MAAMC,WAAW,GAAG;EAClBC,MAAM,EAAEA,CAACA,MAAM,EAAEC,QAAQ,KAAK;IAC5B,IAAI,CAACD,MAAM,IAAIJ,cAAc,CAACM,QAAQ,CAACF,MAAM,CAAC,EAAE;MAC9CC,QAAQ,CAAC,IAAI,EAAE,IAAI,CAAC;IACtB,CAAC,MAAM;MACLE,OAAO,CAACC,KAAK,CAAC,8BAA8BJ,MAAM,EAAE,CAAC;MACrDC,QAAQ,CAAC,IAAII,KAAK,CAAC,uBAAuB,CAAC,CAAC;IAC9C;EACF,CAAC;EACDC,OAAO,EAAE,CAAC,KAAK,EAAE,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,SAAS,CAAC;EACpDC,cAAc,EAAE,CAAC,cAAc,EAAE,eAAe,CAAC;EACjDC,WAAW,EAAE;AACf,CAAC;;AAED;AACA1C,GAAG,CAACE,GAAG,CAAC,IAAAyC,aAAI,EAACV,WAAW,CAAC,CAAC;;AAE1B;AACAjC,GAAG,CAACE,GAAG,CAAC0C,mBAAU,CAAC;AACnB5C,GAAG,CAACE,GAAG,CAAC2C,mBAAW,CAAC;AACpB7C,GAAG,CAACE,GAAG,CAAC4C,uBAAc,CAAC;AACvB9C,GAAG,CAACE,GAAG,CAAC6C,uBAAc,CAAC;AACvB/C,GAAG,CAACE,GAAG,CAAC8C,oBAAW,CAAC;AACpBhD,GAAG,CAACE,GAAG,CAAC+C,4BAAmB,CAAC;;AAE5B;AACAjD,GAAG,CAACkD,IAAI,CAAC,oBAAoB,EAAEtB,MAAM,EAAEuB,8BAAa,EAAE,CAACC,GAAG,EAAEC,GAAG,KAAK;EAClEhB,OAAO,CAACiB,GAAG,CAAC,gBAAgB,EAAEF,GAAG,CAACG,IAAI,CAAC;EACvCF,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAAClC,IAAI,CAAC;IAAEmC,OAAO,EAAE;EAA+B,CAAC,CAAC;AACnE,CAAC,CAAC;;AAEF;AACAzD,GAAG,CAAC0D,OAAO,CAAC,GAAG,EAAE,IAAAf,aAAI,EAACV,WAAW,CAAC,CAAC,CAAC,CAAC;;AAErC;AACA,MAAM1B,QAAS,GAAGC,aAAI,CAACC,OAAO,CAAC,IAAIC,GAAG,CAACC,MAAM,CAACC,IAAI,CAACC,GAAG,CAAC,CAACC,QAAQ,CAAC;AACjEd,GAAG,CAACE,GAAG,CAACD,gBAAO,CAAC0D,MAAM,CAACnD,aAAI,CAACU,IAAI,CAACX,QAAS,EAAE,QAAQ,CAAC,CAAC,CAAC;;AAEvD;AACAP,GAAG,CAAC4D,GAAG,CAAC,GAAG,EAAE,CAACR,GAAG,EAAEC,GAAG,KAAK;EACzB;EACA,MAAMQ,SAAS,GAAGrD,aAAI,CAACsD,OAAO,CAACvD,QAAS,EAAE,QAAQ,EAAE,YAAY,CAAC;EACjE8C,GAAG,CAACU,QAAQ,CAACF,SAAS,EAAGG,GAAG,IAAK;IAC/B,IAAIA,GAAG,EAAE;MACPX,GAAG,CAACG,MAAM,CAAC,GAAG,CAAC,CAACS,IAAI,CAAC,2BAA2B,CAAC;IACnD;EACF,CAAC,CAAC;AACJ,CAAC,CAAC;;AAEF;AACA,MAAMC,IAAI,GAAG9D,OAAO,CAACC,GAAG,CAAC8D,IAAI,IAAI,IAAI;AAErCnE,GAAG,CAACoE,MAAM,CAACF,IAAI,EAAE,SAAS,EAAE,MAAM;EAChC7B,OAAO,CAACiB,GAAG,CAAC,0CAA0CY,IAAI,EAAE,CAAC;AAC/D,CAAC,CAAC;;AAEF;AACA9D,OAAO,CAACiE,EAAE,CAAC,QAAQ,EAAE,MAAM;EACzBC,MAAM,CAACC,KAAK,CAAC,MAAM;IACjBlC,OAAO,CAACiB,GAAG,CAAC,gCAAgC,CAAC;IAC7ClD,OAAO,CAACoE,IAAI,CAAC,CAAC,CAAC;EACjB,CAAC,CAAC;AACJ,CAAC,CAAC","ignoreList":[]}